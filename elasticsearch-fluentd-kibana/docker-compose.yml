version: '3'
# 网络
networks:
  default:  # 默认网络
    external:
      name: dev-network
#  dev:  # dev 网络
#    driver: dev-network   # 网络驱动

# 服务
services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.13.2
    container_name: elasticsearch
    build:
      context: .
      dockerfile: ${ELASTICSEARCH_DIR}/7.13.2/Dockerfile
#    networks:   # 指定网络
#      - dev
    user: root  # 使用root用户启动
    environment:
      - TZ=Asia/Shanghai
      - "cluster.name=elasticsearch"        # 设置集群名称为elasticsearch
      - "discovery.type=single-node"        # 以单一节点模式启动
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"    # 设置使用jvm内存大小
    volumes:
      - ${ELASTICSEARCH_DIR}/plugins:/usr/share/elasticsearch/plugins   # 插件文件挂载
      - ${ELASTICSEARCH_DIR}/data:/usr/share/elasticsearch/data         # 数据文件挂载
    ports:
      - 19200:9200
      - 19300:9300
  fluentd:
    image: quay.io/fluentd_elasticsearch/fluentd:v3.2.0
    container_name: fluentd
    build:
      context: .
      dockerfile: ${FLUENTD_DIR}/3.2.0/Dockerfile
#    networks: # 指定网络
#      - dev
    user: root # 使用root用户启动
    depends_on:   # 依赖服务
      - elasticsearch   # fluentd在elasticsearch启动之后再启动
    environment:
      - TZ=Asia/Shanghai
    volumes:
      - ${FLUENTD_DIR}/log:/fluentd/log   # 日志目录挂载
      - ${FLUENTD_DIR}/etc/fluent.conf:/fluentd/etc/fluent.conf   # 配置文件挂载
    ports:
      - 24221:24221
      - 24222:24222
      - 24223:24223
      - 24224:24224
  kibana:
    image: docker.elastic.co/kibana/kibana:7.13.2
    container_name: kibana
    build:
      context: .
      dockerfile: ${KIBANA_DIR}/7.13.2/Dockerfile
#    networks: # 指定网络
#      - dev
    depends_on: # 依赖服务
      - elasticsearch     # kibana在elasticsearch启动之后再启动
    links:  # 定义别名，从而使用该别名访问其他服务
      - elasticsearch:es  # 使用es这个域名访问elasticsearch服务
    environment:
      - TZ=Asia/Shanghai
      - "elasticsearch.hosts=http://es:9200" # 设置访问elasticsearch的地址
    ports:
      - 15601:5601