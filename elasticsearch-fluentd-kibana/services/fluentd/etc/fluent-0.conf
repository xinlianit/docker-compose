<source>
  #use default nginx main log_format
  @type tail
  tag nginx.access
  path /usr/local/opt/docker/nginx/logs/access.log
  pos_file /tmp/fluentd/pos/nginx/access.log.pos
  format /^(?<remote_ip>[^ ]*) - (?<remote_user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<uri>[^\"]*) +\S*)?" (?<status_code>[^ ]*) (?<response_size>[^ ]*) "(?<referer>[^\"]*)" "(?<user_agent>[^\"]*)" "(?<forwarded_for>[^\"]*)"$/
  time_format %d/%b/%Y:%H:%M:%S %z
  types status_code:integer,response_size:integer
</source>

#### filters ####
<filter nginx.access>
  @type record_transformer
  enable_ruby
  <record>
    path ${URI(URI.encode(uri.strip)).path}
  </record>
</filter>

<match nginx.access>
  @type elasticsearch
  host elasticsearch
  port 9200
  scheme "http"
#   user "elastic"
#   password "$ELASTICSEARCH_PASSWORD"
  logstash_format true
  logstash_prefix nginx.access
  logstash_dateformat %Y.%m.%d
  type_name log
  utc_index false
  reconnect_on_error true
  num_threads 2

  <buffer>
    flush_interval 30s
  </buffer>
</match>